<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriptor Web</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸ§ Transcriptor Web</h1>
        <p>Sube un video o ingresa una URL de YouTube para obtener su transcripciÃ³n en texto.</p>

        <div class="section">
            <h3>ğŸ“ Subir video local</h3>
            <input type="file" id="videoInput" accept="video/*">
            <button onclick="uploadVideo()">Subir y transcribir</button>
        </div>

        <div class="section">
            <h3>ğŸŒ Transcribir desde YouTube</h3>
            <input type="text" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
            <button onclick="processYouTube()">Iniciar</button>
        </div>

        <div id="progress-box">
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <p id="progress-text">â³ Esperando archivo o URL...</p>
        </div>

        <div id="resultBox" class="hidden">
            <h3>ğŸ“ TranscripciÃ³n</h3>
            <textarea id="transcriptionText" readonly></textarea>
            <div class="actions">
                <button onclick="copyText()">ğŸ“‹ Copiar texto</button>
                <a id="downloadLink" href="#" download>ğŸ“„ Descargar TXT</a>
            </div>
        </div>
    </div>

    <script>
        function updateProgress(percent, message) {
            document.getElementById("progress-fill").style.width = percent + "%";
            document.getElementById("progress-text").textContent = message;
        }

        function uploadVideo() {
            const file = document.getElementById("videoInput").files[0];
            if (!file) return alert("Selecciona un archivo de video primero.");

            const formData = new FormData();
            formData.append("video", file);

            updateProgress(10, "ğŸ“¤ Subiendo video...");

            fetch("/upload", { method: "POST", body: formData })
                .then(r => r.json())
                .then(() => monitorProgress());
        }

        function processYouTube() {
            const url = document.getElementById("youtubeUrl").value.trim();
            if (!url) return alert("Ingresa una URL vÃ¡lida de YouTube.");
            updateProgress(10, "ğŸ“¥ Descargando desde YouTube...");

            fetch("/youtube", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ url })
            })
            .then(r => r.json())
            .then(() => monitorProgress());
        }

        function monitorProgress() {
            let percent = 20;
            const interval = setInterval(() => {
                fetch("/progress")
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById("progress-text").textContent = data.message;

                        if (data.status === "processing" && percent < 90) percent += 10;
                        if (data.status === "done") percent = 100;
                        document.getElementById("progress-fill").style.width = percent + "%";

                        if (data.status === "done") {
                            clearInterval(interval);
                            document.getElementById("resultBox").classList.remove("hidden");
                            document.getElementById("transcriptionText").value = data.text || "";
                            document.getElementById("downloadLink").href = "/download";
                        }

                        if (data.status === "error") {
                            clearInterval(interval);
                            document.getElementById("progress-fill").style.background = "#dc3545";
                        }
                    });
            }, 1500);
        }

        function copyText() {
            const text = document.getElementById("transcriptionText");
            text.select();
            document.execCommand("copy");
            alert("Texto copiado al portapapeles âœ…");
        }
    </script>
</body>
</html>
